# NAME=
# SCHEME=
# SUBSPEC=
# VERSION=

XCWORKSPACE=DummyProject/Dummy.xcworkspace
DEPLOYMENT_TARGET=9.0
CONFIGURATION=Release
SIMULATOR='platform=iOS Simulator,name=iPhone SE'

FRAMEWORK_FOLDER=$(NAME).framework
SWIFTMODULE_FOLDER=$(NAME).swiftmodule

### Paths

BUILD_PATH=$(PWD)/.build
BUILD_PATH_SIMULATOR=$(BUILD_PATH)/$(CONFIGURATION)-iphonesimulator
BUILD_PATH_IPHONE=$(BUILD_PATH)/$(CONFIGURATION)-iphoneos
BUILD_PATH_UNIVERSAL=$(BUILD_PATH)/$(CONFIGURATION)-universal
BUILD_PATH_UNIVERSAL_FRAMEWORK_FOLDER=$(BUILD_PATH_UNIVERSAL)/$(FRAMEWORK_FOLDER)
BUILD_PATH_UNIVERSAL_FRAMEWORK_BINARY=$(BUILD_PATH_UNIVERSAL_FRAMEWORK_FOLDER)/$(NAME)

DISTRIBUTION_PATH=$(PWD)/.build
ZIPBALL_NAME=$(SCHEME)$(SUBSPEC)-$(VERSION)-SCF42.zip
ZIPBALL_PATH=$(DISTRIBUTION_PATH)/$(ZIPBALL_NAME)

UPLOAD_FOLDER_NAME=BintrayUpload
TOOLS_PATH=$(PWD)/../../Tools

LICENSE_SEARCH_PATH=$(PWD)/../../Dependencies/$(NAME)/$(VERSION)

### Colors

RESET=\033[0;39m
RED=\033[0;31m
GREEN=\033[0;32m

### Actions

.PHONY: default archive clean test build validate zip

default: test

archive: clean test build validate zip

archive-upload: clean test build validate zip upload

test:
#   xcodebuild -project $(XCWORKSPACE) \
#				  -scheme $(SCHEME) \
#				  -sdk iphonesimulator \
#				  -destination $(SIMULATOR) \
#				  clean test

build: clean

	# Bitcode is not full enabled
	# @link https://github.com/Azure/azure-notificationhubs/issues/40#issuecomment-391603392

	# Using SupportKit (2.10.1) with Xcode 7 causes lots and lots of warnings
	# @link https://github.com/smooch/smooch-ios/issues/53#issuecomment-142632868

	# iOS: How to fix the following warning issues?
	# @link https://stackoverflow.com/a/33206607

	# 200+ warnings generating dSYM in xcode 7
	# @link https://raygun.com/forums/thread/27494

	xcodebuild -workspace $(XCWORKSPACE) \
					-scheme $(SCHEME) \
					-sdk iphonesimulator \
					-configuration $(CONFIGURATION) \
					-arch i386 -arch x86_64 \
					BITCODE_GENERATION_MODE=bitcode \
					CONFIGURATION_BUILD_DIR=$(BUILD_PATH_SIMULATOR) \
					GCC_GENERATE_DEBUGGING_SYMBOLS=NO \
					IPHONEOS_DEPLOYMENT_TARGET=$(DEPLOYMENT_TARGET) \
					OTHER_CFLAGS="-fembed-bitcode" \
					SYMROOT=$(BUILD_PATH) \
					clean build

	xcodebuild -workspace $(XCWORKSPACE) \
					-scheme $(SCHEME) \
					-sdk iphoneos \
					-configuration $(CONFIGURATION) \
					-arch arm64 -arch armv7 -arch armv7s \
					BITCODE_GENERATION_MODE=bitcode \
					CONFIGURATION_BUILD_DIR=$(BUILD_PATH_IPHONE) \
					GCC_GENERATE_DEBUGGING_SYMBOLS=NO \
					IPHONEOS_DEPLOYMENT_TARGET=$(DEPLOYMENT_TARGET) \
					OTHER_CFLAGS="-fembed-bitcode" \
					SYMROOT=$(BUILD_PATH) \
					clean build

#	rm -rf $(BUILD_PATH_UNIVERSAL)
	mkdir -p $(BUILD_PATH_UNIVERSAL)

	@printf "Copy license..." ; echo
	find $(LICENSE_SEARCH_PATH) -maxdepth 1 -type f -name 'LICENSE*' -exec cp '{}' $(BUILD_PATH_UNIVERSAL) \;

	cp -Rv $(BUILD_PATH_SIMULATOR)/$(FRAMEWORK_FOLDER) $(BUILD_PATH_UNIVERSAL)
	cp -Rv $(BUILD_PATH_IPHONE)/$(FRAMEWORK_FOLDER) $(BUILD_PATH_UNIVERSAL)

	lipo $(BUILD_PATH_SIMULATOR)/$(FRAMEWORK_FOLDER)/$(NAME) $(BUILD_PATH_IPHONE)/$(FRAMEWORK_FOLDER)/$(NAME) -create -output $(BUILD_PATH_UNIVERSAL_FRAMEWORK_BINARY)

validate: validate.i386 validate.x86_64 validate.armv7 validate.armv7s validate.arm64

validate.%:
	@printf "Validating $*... "
	@lipo -info $(BUILD_PATH_UNIVERSAL_FRAMEWORK_BINARY) | grep -q '$*' && echo "$(GREEN)Passed$(RESET)" || (echo "$(RED)Failed$(RESET)"; exit 1)

zip:
	mkdir -p $(DISTRIBUTION_PATH)/$(UPLOAD_FOLDER_NAME)/$(NAME)/$(VERSION)
	cd $(BUILD_PATH_UNIVERSAL) && zip -r -FS $(DISTRIBUTION_PATH)/$(UPLOAD_FOLDER_NAME)/$(NAME)/$(VERSION)/$(ZIPBALL_NAME) *

upload:
	@printf "Uploading to bintray..." ; echo
	cd $(TOOLS_PATH) ; sh upload_to_bintray.sh $(DISTRIBUTION_PATH)/$(UPLOAD_FOLDER_NAME)/$(NAME)/$(VERSION) $(NAME) $(VERSION)
	
clean:
#	rm -rf $(BUILD_PATH)
#	rm -rf $(DISTRIBUTION_PATH)

	rm -rf $(BUILD_PATH_SIMULATOR)/$(FRAMEWORK_FOLDER)
	rm -rf $(BUILD_PATH_SIMULATOR)/$(SWIFTMODULE_FOLDER)
	rm -rf $(BUILD_PATH_SIMULATOR)/lib$(NAME).a

	rm -rf $(BUILD_PATH_IPHONE)/$(FRAMEWORK_FOLDER) \
	rm -rf $(BUILD_PATH_IPHONE)/$(SWIFTMODULE_FOLDER)
	rm -rf $(BUILD_PATH_IPHONE)/lib$(NAME).a

	rm -rf $(BUILD_PATH_UNIVERSAL_FRAMEWORK_FOLDER)
	test -d $(BUILD_PATH_UNIVERSAL) && find $(BUILD_PATH_UNIVERSAL) -type f -name 'LICENSE*' -delete || echo "Universal build path doesn't exist. Continue."

	rm -rf $(ZIPBALL_PATH)
